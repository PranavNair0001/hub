name: hub-release-automation

on:
  workflow_dispatch    # Manual trigger event to execute workflow

jobs:

  setup-and-build:    # Job to build packages.json file
    runs-on: new-runner    # Self hosted runner on GKE cluster
    steps:

    - name: Repository Checkout    # Action to access file structure of repository in runner
      uses: actions/checkout@v2.3.4

    - name: Run Script    # Step to execute build.py script that performs operations of this job
      run: python3 ./.github/scripts/build.py

    - name: Store packages.json as Artifact    # Action to upload packages.json as an artifact for further use
      uses: actions/upload-artifact@v3
      with:
        name: packages.json
        path: ./packages.json

  list-files:    # Job to find and list all missing files that need to be fetched
    needs: setup-and-build
    if: success()
    runs-on: new-runner
    steps:

    - name: Repository Checkout    # Action to access file structure of repository in runner
      uses: actions/checkout@v2.3.4

    - name: Run Script    # Step to execute list.py script that performs operations of this job
      run: python3 ./.github/scripts/list.py

    - name: Setting Output    # Step to set resultant list as output of job
      id: set-matrix
      run: echo "::set-output name=matrix::${output}"

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}    # JSON output containing contents of strategy matrix of next job

  fetch-files:    # Job to fetch each missing file individually in parallel
    needs: list-files
    if: ${{ needs.list-files.outputs.matrix != '[]' && needs.list-files.outputs.matrix != '' && success() }}    # Skip job if no file to be fetched
    runs-on: new-runner

    strategy:
      fail-fast: false
      matrix:
        artifact: ${{ fromJSON(needs.list-files.outputs.matrix) }}

    env:
      ID: ${{ matrix.artifact.repo.id }}
      EXTENSION: ${{ matrix.artifact.repo.file_type }}
      DIR: ${{ matrix.artifact.artifactDir }}
      FILEPATH: ${{ matrix.artifact.path }}
      FILENAME: ${{ matrix.artifact.artifact }}

    steps:

    - name: Creating Working Directory    # Step to create a temporary working directory
      run: mkdir artifact

    - name: Sync with GCS    # Step to sync GCS bucket directory that is expected to contain missing file with working directory
      run: gsutil rsync gs://project-step-pranav-hub-cdap-io/$DIR artifact/

    - name: Fetching Missing Files    # Step to find and fetch the missing file
      run: |
        echo "Fetching: ${FILEPATH}"
        if [ -f "artifact/${FILENAME}" ]; then
          echo "${FILENAME} : Found in GCS Bucket"
        else
          echo "${FILENAME} : Not found in GCS Bucket, Fetching from Maven Central"
          mvn org.apache.maven.plugins:maven-dependency-plugin:2.8:copy -Dartifact=${ID}:${VERSION}:${EXTENSION} -DoutputDirectory=./artifact/
        fi

    - name: Upload File    # Action to upload the fetched missing file as an artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact.artifact }}
        path: ${{ matrix.artifact.target_path }}

  merge-files:    # Job to place all artifacts in appropriate location, and push to GCS buckets
    needs: fetch-files
    if: success()
    runs-on: new-runner
    steps:

    - name: Repository Checkout    # Action to access file structure of repository in runner
      uses: actions/checkout@v2.3.4

    - name: Download Artifact    # Action to download all the fetched missing files to a temporary artifacts directory
      uses: actions/download-artifact@v3
      with:
        path: artifacts/

    - name: Run Script    # Step to execute merge.py script that performs operations of this job
      run: python3 ./.github/scripts/merge.py

  sync-regional-buckets:    # Job to sync all regional GCS buckets with central GCS bucket, in parallel
    runs-on: new-runner
    needs: merge-files
    if: success()

    strategy:
      fail-fast: false
      matrix:
        loc: [ "dir1" , "dir2", "dir3", "dir4","dir5", "dir6", "dir7", "dir8", "dir9" ]

    steps:

    - name: Syncing buckets, max 3 retries    # Action to sync bucket, and retry upto 3 times if failed
      uses: nick-fields/retry@v2
      with:
        timeout_seconds: 15
        max_attempts: 3
        retry_on: error
        on_retry_command: echo "The upload to ${{matrix.loc}} has failed"
        command: gsutil -m rsync -d -r gs://project-step-pranav-hub-cdap-io-master/ gs://project-step-pranav-hub-cdap-io-${{ matrix.loc }}/

  failure_mode:    # Job to mail and notify concerned persons, if workflow fails
    runs-on: new-runner
    if: ${{ always() && contains(join(needs.*.result, ','), 'failure') }}
    needs: sync-regional-buckets
    steps:

    - run: echo ${{needs.matrix_regional_buckets.result}}

    - name: Failure, sending email    # Action to send mail
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}}
        subject: Github Action FAILED
        to: pranavnair@google.com
        from: HUB DEMO OFFICIAL
        secure: true
        body: Build job of ${{github.repository}} was a failure on job


#       - name: Revert changes checkout
#         uses: actions/checkout@v2
#         with:
#           fetch-depth: 2
      
#       - name: Declare some variables
#         id: vars
#         shell: bash
#         run: |
#           echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
#           echo "::set-output name=sha_short::$(git rev-parse --short HEAD~1)"

#       - name: Another step
#         run: |
#           echo "Branch: ${{ steps.vars.outputs.branch }}"
#           echo "Sha: ${{ steps.vars.outputs.sha_short }}"

#       - name: Revert changes
#         run: |
#           git config user.name grace-matson
#           git config user.email gracematson@google.com
#           git reset --merge ${{ steps.vars.outputs.sha_short }}
#           git push -f
      


